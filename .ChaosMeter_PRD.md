# Chaos Meter PRD

*Last updated: 2025‑04‑17*

---

## 1 Overview

Add a **Chaos Meter** that reacts to player kill choices, dynamically modifying enemy stats and triggering a “major chaos event” when either faction reaches its limit. This extends the grouping system shipped in `EnemyGrouping_PRD.md`.

- **Scale**: ‑100 (AI dominance) … 0 (balance) … +100 (Coder dominance)
- **Driver**: Only player kills—for now each kill is **±1** Chaos toward the *opposite* faction.
- **Output**: Stat multipliers, panic behavior, UI bar, chaos‑event callback.

---

## 2 Key Requirements

| #  | Requirement                                                                                                                                                                                                                                           | Notes                                                                              |                                                     |                                   |
| -- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- | --------------------------------------------------- | --------------------------------- |
| R1 | **Kill Impact** – Each time the player kills an enemy the meter shifts **±1** toward the *opposite* faction.                                                                                                                                          | Weight table lives in `constants.js` → future tuning.                        |                                                     |                                   |
| R2 | **Hard Clamp** – Value is clamped at ‑100 / +100. Reaching either end fires a `ChaosEvent` once and locks further shifts until reset.                                                                                                                 |                                                                                    |                                                     |                                   |
| R3 | **Aggression Scaling** – If Chaos > 0 (more AI kills) → **Coders** get multipliers; if Chaos < 0 → **AI** gets multipliers.Multipliers affect *HP, Damage, FireRate, DodgeFrequency* and are calculated as:\`1 +                                      | Chaos                                                                              | \* K`where`K\` is per‑stat constant (default 0.01). | Tunable via `constants.js`. |
| R4 | **Panic Behavior** – When the *losing* faction is within 15 points of the other’s max (e.g., Chaos ≥ 85 or ≤ ‑85), its enemies enter **panic** and *flee from the winning group’s enemies*, prioritising avoidance AI for 3 s after each path update. | Panic flag accessible via `enemy.isPanicking()`.                                   |                                                     |                                   |
| R5 | **Chaos Bar HUD** – Add a single bi‑directional bar with center zero, faction colors (AI = blue, Coders = red). Updates every frame; flashes on major event.                                                                                          | Component `ChaosBar.jsx` rendered in `WaveGame.jsx`.                               |                                                     |                                   |
| R6 | **Chaos Event Hook** – When the meter hits ±100 emit `ChaosManager.emit('MAJOR_CHAOS', factionId)`. For now play a screen shake + particle burst effect (placeholder).                                                                                | Event can trigger multiple times if the meter later resets (handled by run‑reset). |                                                     |                                   |
| R7 | All constants (kill weight, K multipliers, panicThreshold, colors) live in a single config file for easy tuning.                                                                                                                                      | `constants.js`.                                                              |                                                     |                                   |
|    |                                                                                                                                                                                                                                                       |                                                                                    |                                                     |                                   |

---

## 3 Architecture Updates

### 3.1 ChaosManager (updated)

| API                       | Description                                                                                    |
| ------------------------- | ---------------------------------------------------------------------------------------------- |
| `registerKill(groupId)`   | Shifts Chaos by ±weight based on killed group, clamps, recalculates multipliers, emits events. |
| `getMultipliers(groupId)` | Returns current { hp, dmg, fire, dodge } scaling factors for that faction.                     |
| `isPanicking(groupId)`    | Boolean if faction is within `PANIC_DELTA` (15) of opponent’s max.                             |
| `on(event, cb)`           | `MAJOR_CHAOS`, `VALUE_CHANGED`.                                                                |

### 3.2 Enemy Runtime

- On spawn → cache a reference to ChaosManager.
- Each update tick → if `isPanicking(groupId)` switch AI state to `PanicFleeState`.
- Combat/damage → multiply base stats by `getMultipliers(groupId)`.

### 3.3 UI

`ChaosBar.jsx`

```txt
<FlexBox>
  <Bar side="left" width={Math.max(0, -chaos)/100} color={AI_COLOR}/>
  <ZeroMarker/>
  <Bar side="right" width={Math.max(0, chaos)/100} color={CODER_COLOR}/>
</FlexBox>
```

---

## 4 User Stories

- **GJG2‑96 (Player Feedback)**: *As a player I see the Chaos bar move when I focus one faction, letting me know I’m shifting balance.*
- **GJG2‑97 (Developer)**: *As a dev I can tweak kill weights and multipliers in a single file without touching engine code.*
- **GJG2‑99 (System)**: *When Chaos reaches ±100 an on‑screen effect and event fire so designers can hook future set‑pieces.*
- \*\*GJG2-98 (System): \*All chaos modifiers should be tracked and easily accessible within the code and debug screen\*

---

## 5 Acceptance Criteria

1. Killing an AI enemy moves the bar **+1**; killing a Coder moves it **‑1**.
2. Chaos value never exceeds ±100 even if kills continue.
3. When Chaos is +20, Coders’ HP/Damage etc. are 1 + 0.20 K; AI remains at base.
4. At Chaos ≥ 85 (Coders lead), AI enemies call `isPanicking()` and actively flee.
5. Reaching ±100 plays screen shake + particle burst and fires `MAJOR_CHAOS` exactly once per cap.
6. All tunable constants are exported in `constants.js` and changing them reflects in‑game without code edits.
7. 60 FPS maintained with 300 active enemies under worst‑case multipliers.

---

## 6 Out‑of‑Scope

- Chaos decay over time.
- Spawn‑rate adjustment.
- Multiplayer replication.
- Audio cues.
- Detailed post‑event storyline or boss spawn.

---

## 7 Deliverables

| File                                 | Type           |
| ------------------------------------ | -------------- |
| `ChaosManager.js` (updated)          | core logic     |
| `constants.js`                        | config         |
| `ChaosBar.jsx`                       | UI component   |
| Enemy AI scripts (panic state)       | updated source |
| `docs/ChaosMeter_PRD.md` (this file) | documentation  |

---

### Changelog

- **2025‑04‑17** – First draft created after user clarification.

